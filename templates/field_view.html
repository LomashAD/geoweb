{% extends "base.html" %}

{% block extra_css %}
<style>
    .field-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .field-map {
        height: 400px;
        border: 1px solid #e9ecef;
        background: #f8f9fa;
    }
    
    .field-info {
        background: #f8f9fa;
        padding: 20px;
        border: 1px solid #e9ecef;
    }
    
    .info-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .info-label {
        font-weight: 600;
        color: #2c3e50;
        display: block;
        margin-bottom: 5px;
    }
    
    .info-value {
        color: #495057;
    }
    
    .history-item {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .history-item:last-child {
        border-bottom: none;
    }
    
    .history-content {
        flex: 1;
    }
    
    .history-crop {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .history-meta {
        color: #6c757d;
        font-size: 14px;
        margin-top: 4px;
    }
    
    .history-notes {
        color: #495057;
        font-style: italic;
        margin-top: 5px;
    }
    
    .empty-history {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    @media (max-width: 768px) {
        .field-details {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title" id="field-title">Загрузка...</h2>
        <a href="{{ url_for('fields_page') }}" class="btn btn-secondary">← Назад к полям</a>
    </div>
    <div class="card-body">
        <div class="field-details">
            <div>
                <div class="field-map" id="field-map"></div>
            </div>
            <div class="field-info">
                <h4>Информация о поле</h4>
                <div id="field-info-content">
                    <div class="info-item">
                        <span class="info-label">Название:</span>
                        <span class="info-value">Загрузка...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Площадь:</span>
                        <span class="info-value">Загрузка...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Создано:</span>
                        <span class="info-value">Загрузка...</span>
                    </div>
                </div>
                <div class="btn-group mt-3">
                    <button onclick="editField()" class="btn btn-primary">Редактировать</button>
                    <button onclick="deleteField()" class="btn btn-danger">Удалить поле</button>
                </div>
            </div>
        </div>
        
        <!-- История культур -->
        <div class="card mt-3">
            <div class="card-header">
                <h4 class="card-title">История культур</h4>
                <button onclick="showAddHistoryForm()" class="btn btn-primary btn-sm">Добавить запись</button>
            </div>
            <div class="card-body">
                <div id="field-history">
                    <div class="empty-history">
                        <p>Загрузка истории...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Форма добавления истории -->
        <div id="add-history-form" style="display: none;" class="card mt-3">
            <div class="card-header">
                <h4 class="card-title">Добавить запись в историю</h4>
            </div>
            <div class="card-body">
                <form id="history-form">
                    <div class="form-group">
                        <label class="form-label">Культура *</label>
                        <select id="crop-select" class="form-control" required>
                            <option value="">Выберите культуру</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Год *</label>
                        <input type="number" id="history-year" class="form-control" min="2000" max="2030" required value="{{ current_year }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Сезон *</label>
                        <select id="history-season" class="form-control" required>
                            <option value="весна-лето">Весна-лето</option>
                            <option value="озимые">Озимые</option>
                            <option value="лето-осень">Лето-осень</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Примечания</label>
                        <textarea id="history-notes" class="form-control" rows="3" placeholder="Дополнительная информация о посеве..."></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                        <button type="button" onclick="hideAddHistoryForm()" class="btn btn-secondary">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
let currentFieldId = null;
let currentField = null;

// Загрузка данных поля
async function loadFieldData(fieldId) {
    try {
        const response = await fetch(`/api/fields/${fieldId}`);
        const field = await response.json();
        
        currentField = field;
        currentFieldId = fieldId;
        
        // Обновляем заголовок
        document.getElementById('field-title').textContent = field.name;
        
        // Обновляем информацию
        document.getElementById('field-info-content').innerHTML = `
            <div class="info-item">
                <span class="info-label">Название:</span>
                <span class="info-value">${field.name}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Площадь:</span>
                <span class="info-value">${field.area || '0'} га</span>
            </div>
            <div class="info-item">
                <span class="info-label">Создано:</span>
                <span class="info-value">${new Date(field.created_at).toLocaleDateString('ru-RU')}</span>
            </div>
        `;
        
        // Инициализируем карту
        initFieldMap(field);
        
        // Загружаем историю
        loadFieldHistory(fieldId);
        
        // Загружаем список культур для формы
        loadCropsForSelect();
        
    } catch (error) {
        console.error('Ошибка загрузки поля:', error);
        document.getElementById('field-info-content').innerHTML = '<p class="text-danger">Ошибка загрузки данных поля</p>';
    }
}

// Инициализация карты поля
function initFieldMap(field) {
    try {
        const geometry = JSON.parse(field.geometry);
        const map = L.map('field-map');
        
        // Добавляем слой карты
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
        
        // Добавляем поле на карту
        const fieldLayer = L.geoJSON(geometry, {
            style: {
                color: '#27ae60',
                fillColor: '#27ae60',
                fillOpacity: 0.3,
                weight: 2
            }
        }).addTo(map);
        
        // Центрируем карту на поле
        map.fitBounds(fieldLayer.getBounds());
        
    } catch (error) {
        console.error('Ошибка инициализации карты:', error);
        document.getElementById('field-map').innerHTML = '<p class="text-danger">Ошибка загрузки карты</p>';
    }
}

// Загрузка истории поля
async function loadFieldHistory(fieldId) {
    try {
        const response = await fetch(`/api/crop-history?field_id=${fieldId}`);
        const history = await response.json();
        
        displayFieldHistory(history);
    } catch (error) {
        console.error('Ошибка загрузки истории:', error);
        document.getElementById('field-history').innerHTML = '<p class="text-danger">Ошибка загрузки истории</p>';
    }
}

// Отображение истории поля
function displayFieldHistory(history) {
    const container = document.getElementById('field-history');
    
    if (history.length === 0) {
        container.innerHTML = `
            <div class="empty-history">
                <p>История культур отсутствует</p>
                <p><small>Добавьте первую запись о выращиваемой культуре</small></p>
            </div>
        `;
        return;
    }
    
    // Сортируем по году (новые сверху)
    history.sort((a, b) => b.year - a.year);
    
    container.innerHTML = history.map(item => `
        <div class="history-item">
            <div class="history-content">
                <div class="history-crop">${item.crop_name}</div>
                <div class="history-meta">${item.year} год · ${item.season}</div>
                ${item.notes ? `<div class="history-notes">${item.notes}</div>` : ''}
            </div>
            <div>
                <button onclick="deleteHistoryItem(${item.id})" class="btn btn-danger btn-sm">Удалить</button>
            </div>
        </div>
    `).join('');
}

// Загрузка культур для выпадающего списка
async function loadCropsForSelect() {
    try {
        const response = await fetch('/api/crops');
        const crops = await response.json();
        
        const select = document.getElementById('crop-select');
        select.innerHTML = '<option value="">Выберите культуру</option>' +
            crops.map(crop => `<option value="${crop.id}">${crop.name}</option>`).join('');
    } catch (error) {
        console.error('Ошибка загрузки культур:', error);
    }
}

// Показать форму добавления истории
function showAddHistoryForm() {
    document.getElementById('add-history-form').style.display = 'block';
    document.getElementById('history-year').value = new Date().getFullYear();
}

// Скрыть форму добавления истории
function hideAddHistoryForm() {
    document.getElementById('add-history-form').style.display = 'none';
    document.getElementById('history-form').reset();
}

// Удаление записи истории
async function deleteHistoryItem(historyId) {
    if (!confirm('Удалить эту запись истории?')) return;
    
    try {
        const response = await fetch(`/api/crop-history/${historyId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Ошибка удаления: ' + result.error);
        } else {
            alert('Запись удалена!');
            loadFieldHistory(currentFieldId);
        }
    } catch (error) {
        console.error('Ошибка удаления:', error);
        alert('Ошибка удаления записи');
    }
}

// Редактирование поля
function editField() {
    const newName = prompt('Введите новое название поля:', currentField.name);
    if (newName && newName !== currentField.name) {
        updateFieldName(newName);
    }
}

// Обновление названия поля
async function updateFieldName(newName) {
    try {
        const response = await fetch(`/api/fields/${currentFieldId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: newName
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Ошибка обновления: ' + result.error);
        } else {
            currentField.name = newName;
            document.getElementById('field-title').textContent = newName;
            document.querySelector('.info-value').textContent = newName;
            alert('Название поля обновлено!');
        }
    } catch (error) {
        console.error('Ошибка обновления:', error);
        alert('Ошибка обновления поля');
    }
}

// Удаление поля
function deleteField() {
    if (!confirm('Вы уверены, что хотите удалить это поле? Все данные истории будут потеряны.')) return;
    
    fetch(`/api/fields/${currentFieldId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            alert('Ошибка удаления: ' + result.error);
        } else {
            alert('Поле удалено!');
            window.location.href = "{{ url_for('fields_page') }}";
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка удаления поля');
    });
}

// Обработка формы добавления истории
document.getElementById('history-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const cropSelect = document.getElementById('crop-select');
    const yearInput = document.getElementById('history-year');
    
    if (!cropSelect.value) {
        alert('Пожалуйста, выберите культуру');
        return;
    }
    
    if (!yearInput.value || yearInput.value < 2000 || yearInput.value > 2030) {
        alert('Пожалуйста, введите корректный год (2000-2030)');
        return;
    }
    
    const formData = {
        field_id: currentFieldId,
        crop_id: cropSelect.value,
        year: parseInt(yearInput.value),
        season: document.getElementById('history-season').value,
        notes: document.getElementById('history-notes').value
    };
    
    try {
        const response = await fetch('/api/crop-history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Ошибка сохранения: ' + result.error);
        } else {
            alert('Запись добавлена!');
            hideAddHistoryForm();
            loadFieldHistory(currentFieldId);
        }
    } catch (error) {
        console.error('Ошибка сохранения:', error);
        alert('Ошибка сохранения записи');
    }
});

// Загрузка данных при открытии страницы
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const fieldId = urlParams.get('id');
    
    if (fieldId) {
        loadFieldData(fieldId);
    } else {
        document.getElementById('field-info-content').innerHTML = '<p class="text-danger">ID поля не указан</p>';
    }
});
</script>
{% endblock %}